/*******************************************************************************************************************************//**
 *
 * @file	PR_Towercontrol.c
 * @brief	Funciones para controlar los motores de las torres
 * @date
 * @author
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "PR_Towercontrol.h"
#include "PR_PWM.h"
#include "PR_timer.h"
#include "../inc/DR_tipos.h"
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/
volatile uint16_t LastControl;
volatile uint16_t TowerPositionOld = 0;
volatile uint16_t TowerPosition = 0 ;
/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/

/**
	\fn  Tower_Control
	\brief Controla el movimiento de los motores de las torres
 	\author
 	\date
 	\param [in] milimeters : la distancia que queremos mover las torres en milimetros
 	\param [out]
	\return
*/
void Tower_Control ( uint16_t milimeters , uint8_t direction ){
	LastControl = milimeters;
	if(direction== UP)LastControl * (-1);
	TowerPositionOld += LastControl;
	moveteMotorPWM(TOWER_MOTOR, ON, direction);
	startTimer( milimeters*STEP, update_tower , MILLISECONDS);
}

/**
	\fn  update_tower
	\brief Al vencer el timer en Tower_Control llama a esta funcion para actualizar la variable que nos da la posicion de la sierra
 	\author
 	\date
 	\param [in]
 	\param [out]
	\return
*/
void update_tower( void )
{
	moveteMotorPWM(TOWER_MOTOR, OFF, DOWN);
	TowerPosition += LastControl;
}

/**
	\fn  reset_tower
	\brief Resetea todos los contadores de la torre
 	\author
 	\date
 	\param [in]
 	\param [out]
	\return
*/
void reset_tower( void ) {
LastControl = 0;
TowerPositionOld = 0;
TowerPosition = 0 ;
}
